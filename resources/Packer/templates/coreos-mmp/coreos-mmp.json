{
  "variables": 
  {
    "coreos_channel":  "{{ env `COREOS_CHANNEL` }}",
    "coreos_version":  "{{ env `COREOS_VERSION` }}",
    "boxes_directory": "shared/boxes",
    "debug_provision": "no",
    "headless": "true",
    "iso_url": "http://{{ env `COREOS_CHANNEL` }}.release.core-os.net/amd64-usr/{{ env `COREOS_VERSION` }}/coreos_production_iso_image.iso",
    "iso_checksum_type": "sha512",
    "iso_checksum": "{{ env `COREOS_ISO_SHA512_CHECKSUM` }}",
    "ssh_username": "core",
    "ssh_password": "vmware",
    "ostype_vmware": "other26xlinux-64",
    "output_directory": "templates/coreos-mmp/images"
  },
  "builders":
  [
    {
      "name": "vmware",
      "type": "vmware-iso",
      "boot_wait": "30s",
      "guest_os_type": "{{ user `ostype_vmware` }}",
    
      "vm_name": "coreos",
      
      "vmdk_name": "coreos",
	  "disk_type_id": "0",
      "disk_size": 20480,
        
      "iso_url": "{{ user `iso_url` }}",
      "iso_checksum_type": "{{ user `iso_checksum_type` }}",
      "iso_checksum": "{{ user `iso_checksum` }}",
        
      "ssh_username": "{{ user `ssh_username` }}",
      "ssh_password": "{{ user `ssh_password` }}",
      "ssh_wait_timeout": "2h",
    
      "headless": "{{ user `headless` }}",
      
      "http_directory": "templates/coreos-mmp/http",
    
      "shutdown_command": "sudo shutdown -P now",

      "skip_compaction": true,
    
      "vmx_data": 
      {
        "cpuid.coresPerSocket": "1",
        "numvcpus": "1",
    
        "memsize": "1024",
    
        "floppy0.present": "FALSE",      

        "config.version": "8",
        "virtualHW.version": "8",

        "ethernet0.virtualDev": "vmxnet3",
      
        "usb.present": "FALSE",
        "usb.generic.autoconnect": "FALSE",
        "sound.present": "FALSE",
      
        "powerType.powerOff": "soft",
        "powerType.powerOn":  "hard",
        "powerType.reset":  "hard",
        "powerType.suspend":  "hard"
      },
      
      "boot_command": 
      [
        "<enter>sudo -i<enter>",
        "systemctl stop sshd.socket<enter>",
        "wget http://{{ .HTTPIP }}:{{ .HTTPPort }}/install.yml<enter>",
        "coreos-install -V {{user `coreos_version`}} -d /dev/sda -C {{user `coreos_channel`}} -c install.yml<enter>",
        "reboot<enter>"
      ],      
          
      "output_directory": "{{ user `output_directory` }}"
    }    
  ],
  "provisioners": 
  [
    {
      "type": "shell",
      "inline": 
      [
      	"sudo groupadd -g 600 vagrant",
      	"sudo useradd -u 600 -g 600 -G docker,sudo -m -d /home/vagrant -p $(openssl passwd -1 $(tr -dc A-Za-z0-9_ < /dev/urandom | head -c24)) vagrant",
      	"sudo mkdir -p /home/vagrant/.ssh",
      	"sudo chmod 700 /home/vagrant/.ssh",
        "sudo wget --no-check-certificate 'https://raw.github.com/mitchellh/vagrant/master/keys/vagrant.pub' -O /home/vagrant/.ssh/authorized_keys",
        "sudo chmod 600 /home/vagrant/.ssh/authorized_keys",
        "sudo chown -R vagrant.vagrant /home/vagrant/.ssh"
      ]
    }
  ],
  "post-processors":
  [
    [
      {
        "type": "vagrant",
        "keep_input_artifact": true,
        "output": "{{ user `boxes_directory` }}/coreos-mmp-{{.Provider}}.box",
        "vagrantfile_template": "templates/coreos-mmp/Vagrantfile",
        "include": 
        [
    	  "templates/coreos-mmp/base_mac.rb",
    	  "templates/coreos-mmp/change_host_name.rb",
    	  "templates/coreos-mmp/configure_networks.rb"
        ]
      }
    ]
  ]  
}






